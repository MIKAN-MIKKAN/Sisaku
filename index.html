<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
<style>
  .ok { color: green; }
  .ng { color: red; }
  .box { margin-top:10px; padding:8px; background:#f4f4f4; }
  button { margin-top:6px; }
</style>
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

const QUESTIONS = [
 ["ubiquitous","至る所にある"],
 ["meticulous","細心の注意を払う"],
 ["ambiguous","曖昧な"],
 ["cognitive","認知の"],
 ["inevitable","避けられない"],
 ["arbitrary","恣意的な"],
 ["plausible","もっともらしい"],
 ["coherent","首尾一貫した"],
 ["salient","顕著な"],
 ["implicit","暗黙の"]
];

let subject_id = "";
let mode = "learn";
let index = 0;
let answers = new Array(10);

// ロック系
let locked = false;      // 1問内の多重操作防止
let submitted = false;  // 結果送信の多重防止

init();

function init(){
  document.getElementById("main").innerHTML = `
    <input id="sid" placeholder="A01 / B01"><br><br>
    <button onclick="start('learn')">初回学習</button>
    <button onclick="start('review')">復習</button>
    <button onclick="start('test')">テスト</button>
  `;
}

function start(m){
  const sid = document.getElementById("sid").value;
  if(!/^([AB][0-9]{2})$/.test(sid)){
    alert("ID不正");
    return;
  }
  subject_id = sid;
  mode = m;

  // 初期化
  index = 0;
  answers.fill("");
  locked = false;
  submitted = false;

  show();
}

function show(){
  locked = false;

  const [q,a] = QUESTIONS[index];
  let html = `<p>${index+1} / 10</p><p><b>${q}</b></p>`;

  if(mode === "learn"){
    html += `<p>${a}</p>`;
  }

  html += `
    <input id="ans">
    <button onclick="check()">回答</button>
  `;

  document.getElementById("main").innerHTML = html;
}

function check(){
  if(locked) return;
  locked = true;

  const input = document.getElementById("ans").value.trim();
  answers[index] = input;

  const correct = QUESTIONS[index][1];
  const ok = input === correct;

  let html = "";
  if(mode !== "test"){
    html = `
      <div class="box">
        あなた：${input || "(無回答)"}<br>
        正解：${correct}<br>
        <span class="${ok ? "ok" : "ng"}">
          ${ok ? "⭕ 正解" : "❌ 不正解"}
        </span>
      </div>
    `;
  }

  html += `<button onclick="next()">次へ</button>`;
  document.getElementById("main").innerHTML += html;
}

function next(){
  if(submitted) return; // 念のため

  index++;
  if(index < 10){
    show();
  } else {
    finish();
  }
}

/* ===== 論文準拠モデル ===== */

function calcParams(score){
  const accuracy = score / 10;
  const alpha = (subject_id[0] === "A") ? 0.6 : 0.9;
  const beta = Math.max(0.05, 0.25 * (1 - accuracy));
  return { alpha, beta };
}

function calcNextDateTimeInitial(){
  const d = new Date();
  d.setTime(d.getTime() + 12 * 60 * 60 * 1000); // 12時間後
  return d;
}

function calcNextDateTimeModel(alpha, beta){
  const theta = 0.7;
  const t = Math.pow(-Math.log(theta) / beta, 1 / alpha); // days
  const ms = t * 24 * 60 * 60 * 1000;
  const d = new Date();
  d.setTime(d.getTime() + ms);
  return d;
}

async function finish(){
  if(submitted) return;   // ★ ここが核心
  submitted = true;

  let score = 0;
  for(let i=0;i<10;i++){
    if(answers[i] === QUESTIONS[i][1]) score++;
  }

  const { alpha, beta } = calcParams(score);

  await fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({
      subject_id,
      answers,
      score,
      mode,
      alpha,
      beta
    })
  });

  let html = `<h3>得点 ${score} / 10</h3>`;

  if(subject_id[0] === "A" && mode !== "test"){
    const next = (mode === "learn")
      ? calcNextDateTimeInitial()
      : calcNextDateTimeModel(alpha, beta);

    html += `<p><b>次回学習日時：</b>${next.toLocaleString()}</p>`;
  }

  document.getElementById("main").innerHTML = html;
}
</script>
</body>
</html>
