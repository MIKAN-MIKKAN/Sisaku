<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: sans-serif;
  padding: 20px;
}
button {
  font-size: 16px;
  padding: 6px;
}
.loading {
  color: blue;
}
.word {
  font-size: 20px;
  font-weight: bold;
}
.meaning {
  margin-top: 6px;
  background: #f2f2f2;
  padding: 8px;
}
</style>
</head>

<body>
<h2>記憶実験（Day1）</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

let subject_id = localStorage.getItem("subject_id");
let startTime = null;
let answered = false;

if (!subject_id) showId();
else load();

function showId() {
  document.getElementById("main").innerHTML = `
    <p>被験者IDを入力してください</p>
    <input id="sid" placeholder="S01">
    <br>
    <button onclick="saveId()">開始</button>
  `;
}

function saveId() {
  subject_id = document.getElementById("sid").value.trim();
  localStorage.setItem("subject_id", subject_id);
  load();
}

async function load() {
  document.getElementById("main").innerHTML =
    "<p class='loading'>通信中…</p>";

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ subject_id })
  });

  const data = await res.json();

  if (data.status === "do") {
    answered = false;
    startTime = Date.now();

    document.getElementById("main").innerHTML = `
      <p>Day ${data.day}</p>

      <div class="word">${data.word_en}</div>
      <div class="meaning">${data.word_ja}</div>

      <p>下に写してください（覚えるため）</p>
      <input id="ans">
      <br>
      <button id="sendBtn" onclick="send()">回答</button>
    `;
  }

  if (data.status === "saved") {
    const t = new Date(data.next_time);
    document.getElementById("main").innerHTML = `
      <p>保存しました。</p>
      <p><b>次回学習日：</b><br>${t.toLocaleString()}</p>
    `;
  }

  if (data.status === "error") {
    document.getElementById("main").innerHTML =
      "<p>エラーが発生しました</p>";
  }
}

async function send() {
  if (answered) return;
  answered = true;

  const btn = document.getElementById("sendBtn");
  btn.disabled = true;

  const ans = document.getElementById("ans").value;
  const rt = Math.floor((Date.now() - startTime) / 1000);

  document.getElementById("main").innerHTML +=
    "<p class='loading'>通信中…</p>";

  await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      subject_id,
      answer: ans,
      rt
    })
  });

  load();
}
</script>
</body>
</html>
