<h2>記憶実験</h2>
<div id="main"></div>

<script>
/* ===== 設定 ===== */
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

/* ===== 初期処理 ===== */
let subject_id = localStorage.getItem("subject_id");
let startTime = null;

if (!subject_id) {
  showIdInput();
} else {
  checkStatus();
}

/* ===== ID入力画面 ===== */
function showIdInput() {
  document.getElementById("main").innerHTML = `
    <p>被験者IDを入力してください</p>
    <input id="sid" placeholder="S01">
    <br>
    <button onclick="saveId()">開始</button>
  `;
}

function saveId() {
  const id = document.getElementById("sid").value.trim();
  if (!id) {
    alert("被験者IDを入力してください");
    return;
  }
  localStorage.setItem("subject_id", id);
  subject_id = id;
  checkStatus();
}

/* ===== サーバー確認 ===== */
async function checkStatus() {
  try {
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({ subject_id })
    });

    const data = await res.json();

    if (data.status === "registered") {
      location.reload();
      return;
    }

    if (data.status === "wait") {
      document.getElementById("main").innerHTML = `
        <p>まだ学習時間ではありません</p>
        <p><b>次回：${new Date(data.next_time).toLocaleString()}</b></p>
      `;
      return;
    }

    if (data.status === "do") {
      startTime = Date.now();
      document.getElementById("main").innerHTML = `
        <p>Day ${data.day}</p>
        <p>${data.question}</p>
        <input id="ans">
        <br>
        <button onclick="sendAnswer()">送信</button>
      `;
      return;
    }

    if (data.status === "saved") {
      document.getElementById("main").innerHTML = `
        <p>保存しました</p>
        <p><b>次回：${new Date(data.next_time).toLocaleString()}</b></p>
      `;
    }

  } catch (e) {
    document.getElementById("main").innerHTML =
      "<p style='color:red'>通信エラー</p>";
    console.error(e);
  }
}

/* ===== 回答送信 ===== */
async function sendAnswer() {
  const ans = document.getElementById("ans").value.trim();
  if (!ans) return alert("答えを入力してください");

  const rt = Math.floor((Date.now() - startTime) / 1000);

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      subject_id,
      answer: ans,
      correct: ans === "エビングハウス" ? 1 : 0,
      rt
    })
  });

  const data = await res.json();

  document.getElementById("main").innerHTML = `
    <p>保存しました</p>
    <p><b>次回：${new Date(data.next_time).toLocaleString()}</b></p>
  `;
}
</script>
