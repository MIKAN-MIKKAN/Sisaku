<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

let subject_id = localStorage.getItem("subject_id");
let startTime = null;

if (!subject_id) showId();
else check();

function showId() {
  main.innerHTML = `
    <input id="sid" placeholder="S01">
    <button onclick="save()">開始</button>
  `;
}

function save() {
  subject_id = sid.value.trim();
  localStorage.setItem("subject_id", subject_id);
  check();
}

async function check() {
  const r = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ subject_id })
  });
  const d = await r.json();

  if (d.status === "registered") location.reload();

  if (d.status === "wait")
    main.innerHTML =
      `次回：${new Date(d.next_time).toLocaleString()}`;

  if (d.status === "do") {
    startTime = Date.now();
    main.innerHTML = `
      ${d.question}<br>
      <input id="ans">
      <button onclick="send()">送信</button>
    `;
  }

  if (d.status === "saved")
    main.innerHTML =
      `保存完了<br>次回：${new Date(d.next_time).toLocaleString()}`;
}

async function send() {
  const rt = Math.floor((Date.now()-startTime)/1000);
  const a = ans.value.trim();

  const r = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      subject_id,
      answer: a,
      correct: a==="エビングハウス"?1:0,
      rt
    })
  });
  const d = await r.json();
  main.innerHTML =
    `次回：${new Date(d.next_time).toLocaleString()}`;
}
</script>
</body>
</html>
