<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
<style>
  .ok { color: green; }
  .ng { color: red; }
  .box { margin-top: 10px; padding: 8px; background: #f4f4f4; }
</style>
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

const QUESTIONS = [
  "ubiquitous","meticulous","ambiguous","cognitive","inevitable",
  "arbitrary","plausible","coherent","salient","implicit"
];

let subject_id = "";
let mode = "initial";
let index = 0;
let answers = [];
let start_time = "";

showStart();

function showStart() {
  document.getElementById("main").innerHTML = `
    <input id="sid" placeholder="A01 / B01"><br><br>
    <button onclick="selectMode('initial')">初回学習</button>
    <button onclick="selectMode('review')">復習</button>
    <button onclick="selectMode('test')">テスト</button>
  `;
}

function selectMode(m) {
  const sid = document.getElementById("sid").value.trim();
  if (!/^([AB][0-9]{2})$/.test(sid)) {
    alert("ID形式が不正です");
    return;
  }
  subject_id = sid;
  mode = m;
  index = 0;
  answers = [];
  start_time = new Date().toISOString();
  showQuestion();
}

function showQuestion() {
  document.getElementById("main").innerHTML = `
    <p>${index + 1} / 10</p>
    <p><b>${QUESTIONS[index]}</b></p>
    <input id="ans">
    <button onclick="check()">回答</button>
  `;
}

function check() {
  const btn = document.querySelector("button");
  btn.disabled = true;

  const ans = document.getElementById("ans").value;
  answers.push(ans);

  const correct = getCorrect(index);
  const ok = ans === correct;

  let feedback = "";
  if (mode !== "test") {
    feedback = `
      <div class="box">
        <p>正解：${correct}</p>
        <p class="${ok ? "ok" : "ng"}">
          ${ok ? "⭕ 正解" : "❌ 不正解"}
        </p>
        <button onclick="next()">次へ</button>
      </div>
    `;
  } else {
    feedback = `<button onclick="next()">次へ</button>`;
  }

  document.getElementById("main").innerHTML += feedback;
}

function next() {
  index++;
  if (index < QUESTIONS.length) {
    showQuestion();
  } else {
    finish();
  }
}

async function finish() {
  const end_time = new Date().toISOString();

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      subject_id,
      mode,
      answers,
      start_time,
      end_time
    })
  });

  const data = await res.json();

  let html = `
    <h3>結果</h3>
    <p>得点：${data.score} / 10</p>
  `;

  if (data.next_date) {
    html += `<p>次回学習日：${new Date(data.next_date).toLocaleDateString()}</p>`;
  }

  document.getElementById("main").innerHTML = html;
}

function getCorrect(i) {
  const map = {
    0: "至る所にある",
    1: "細心の注意を払う",
    2: "曖昧な",
    3: "認知の",
    4: "避けられない",
    5: "恣意的な",
    6: "もっともらしい",
    7: "首尾一貫した",
    8: "顕著な",
    9: "暗黙の"
  };
  return map[i];
}
</script>
</body>
</html>
