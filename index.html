<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

let subject_id = localStorage.getItem("subject_id");

if (!subject_id) {
  document.getElementById("main").innerHTML = `
    <input id="sid">
    <button onclick="start()">開始</button>
  `;
} else {
  check();
}

function start() {
  subject_id = document.getElementById("sid").value;
  localStorage.setItem("subject_id", subject_id);
  check();
}

async function check(answer) {
  const body = answer
    ? { subject_id, answer }
    : { subject_id };

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify(body)
  });
  const data = await res.json();

  if (data.status === "do") {
    document.getElementById("main").innerHTML = `
      <p>${data.question}</p>
      <input id="ans">
      <button onclick="send()">送信</button>
      <p>${data.index + 1} / 20</p>
    `;
  }

  if (data.status === "finished") {
    let html = "<h3>結果</h3>";
    data.answers.forEach((a, i) => {
      html += `
        <p>
          ${i+1}. ${a.q}<br>
          正解：${a.correct}<br>
          あなた：${a.your} ${a.ok ? "⭕" : "❌"}
        </p>`;
    });
    document.getElementById("main").innerHTML = html;
  }
}

function send() {
  const ans = document.getElementById("ans").value;
  check(ans);
}
</script>
</body>
</html>
