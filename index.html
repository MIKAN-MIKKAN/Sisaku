<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
<style>
  .ok { color: green; }
  .ng { color: red; }
  textarea { width:100%; height:60px; }
  .box { background:#f4f4f4; padding:8px; margin-top:8px; }
</style>
</head>
<body>

<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

const QUESTIONS = [
  ["ubiquitous","至る所にある"],
  ["meticulous","細心の注意を払う"],
  ["ambiguous","曖昧な"],
  ["cognitive","認知の"],
  ["inevitable","避けられない"],
  ["arbitrary","恣意的な"],
  ["plausible","もっともらしい"],
  ["coherent","首尾一貫した"],
  ["salient","顕著な"],
  ["implicit","暗黙の"]
];

let subject_id, mode;
let index = 0;
let answers = [];
let start_time;

document.getElementById("main").innerHTML = `
<input id="sid" placeholder="A01 / B01"><br>
<button onclick="start('first')">初回学習</button>
<button onclick="start('review')">復習</button>
<button onclick="start('test')">テスト</button>
`;

function start(m){
  subject_id = document.getElementById("sid").value;
  if(!/^([AB][0-9]{2})$/.test(subject_id)){
    alert("ID不正"); return;
  }
  mode = m;
  index = 0;
  answers = [];
  start_time = new Date().toISOString();
  showQuestion();
}

function showQuestion(){
  const [q,a] = QUESTIONS[index];
  let html = `<p>${index+1}/10</p><b>${q}</b><br>`;
  if(mode === "first"){
    html += `<p>${a}</p>`;
  }
  html += `
    <textarea id="ans"></textarea><br>
    <button onclick="submitAnswer()">回答</button>
  `;
  document.getElementById("main").innerHTML = html;
}

function submitAnswer(){
  const input = document.getElementById("ans").value.trim();
  const correct = QUESTIONS[index][1];

  if(mode === "first" && input !== correct){
    alert("正しく書いてください");
    return;
  }

  answers.push(input);

  // ===== 復習モードは即時フィードバック =====
  if(mode === "review"){
    const ok = input === correct;
    document.getElementById("main").innerHTML += `
      <div class="box">
        あなた：${input}<br>
        正解：${correct}<br>
        <span class="${ok ? "ok" : "ng"}">
          ${ok ? "⭕ 正解" : "❌ 不正解"}
        </span><br>
        <button onclick="next()">次へ</button>
      </div>
    `;
  } else {
    next();
  }
}

function next(){
  index++;
  if(index < QUESTIONS.length){
    showQuestion();
  } else {
    finish();
  }
}

async function finish(){
  const res = await fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({
      subject_id,
      answers,
      mode,
      start_time
    })
  });
  const data = await res.json();

  let html = `<h3>得点 ${data.score}/10</h3>`;

  // ===== 次回学習日表示（A群 & test以外）=====
  if(subject_id[0] === "A" && mode !== "test"){
    html += `<p><b>次回学習日：</b>${
      new Date(data.next_date).toLocaleDateString()
    }</p>`;
  }

  document.getElementById("main").innerHTML = html;
}
</script>
</body>
</html>
