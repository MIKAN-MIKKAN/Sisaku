<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">

<style>
  textarea {
    width: 100%;
    height: 60px;
    font-size: 16px;
  }
  button {
    margin-top: 10px;
    font-size: 16px;
  }
</style>
</head>

<body>

<h2>記憶実験</h2>
<div id="main"></div>

<script>
// ===== GAS WebアプリURL =====
const URL = "https://script.google.com/macros/s/AKfycbxVwFgOSDtVfPyJ90PIejdAy2PzmUcQR8LAXTdsJ2x8l0T49G1zvQe4Ec64HDAsVlzvevQ/exec";

// ===== 問題 =====
const QUESTIONS = [
  ["ubiquitous","至る所にある"],
  ["meticulous","細心の注意を払う"],
  ["ambiguous","曖昧な"],
  ["cognitive","認知の"],
  ["inevitable","避けられない"],
  ["arbitrary","恣意的な"],
  ["plausible","もっともらしい"],
  ["coherent","首尾一貫した"],
  ["salient","顕著な"],
  ["implicit","暗黙の"]
];

let index = 0;
let answers = [];
let subject_id = "";
let start_time = "";

// ===== 初期画面 =====
showStart();

function showStart() {
  document.getElementById("main").innerHTML = `
    <p>IDを入力してください（A01 / B01 など）</p>
    <input id="sid" placeholder="A01" />
    <br>
    <button onclick="start()">開始</button>
  `;
}

// ===== 開始 =====
function start() {
  const sid = document.getElementById("sid").value.trim();

  if (!/^([AB][0-9]{2})$/.test(sid)) {
    alert("ID形式が不正です（A01 / B01 など）");
    return;
  }

  subject_id = sid;
  start_time = new Date().toISOString();
  index = 0;
  answers = [];

  showQuestion();
}

// ===== 問題表示（初回学習モード）=====
function showQuestion() {
  const [word, meaning] = QUESTIONS[index];

  document.getElementById("main").innerHTML = `
    <p>${index + 1} / 10</p>
    <p><b>${word}</b></p>
    <p>意味：${meaning}</p>
    <p>下の枠に正しく書き写してください</p>
    <textarea id="ans"></textarea>
    <br>
    <button onclick="next()">次へ</button>
  `;
}

// ===== 次へ =====
function next() {
  const input = document.getElementById("ans").value.trim();
  const correct = QUESTIONS[index][1];

  if (input !== correct) {
    alert("意味を正確に入力してください");
    return;
  }

  answers.push(input);
  index++;

  if (index < QUESTIONS.length) {
    showQuestion();
  } else {
    finish();
  }
}

// ===== 終了・送信 =====
async function finish() {
  try {
    const res = await fetch(URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        subject_id: subject_id,
        answers: answers,
        start_time: start_time
      })
    });

    const data = await res.json();

    let html = `
      <h3>学習終了</h3>
      <p><b>得点：</b>${data.score} / 10</p>
    `;

    if (data.next_date) {
      html += `<p><b>次回学習日：</b>${new Date(data.next_date).toLocaleDateString()}</p>`;
    }

    document.getElementById("main").innerHTML = html;

  } catch (e) {
    alert("通信エラーが発生しました");
    console.error(e);
  }
}
</script>

</body>
</html>
