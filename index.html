<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
<style>
  textarea {
    width: 100%;
    height: 60px;
    font-size: 16px;
    margin-bottom: 10px;
  }
  .ok { color: green; }
  .ng { color: red; }
</style>
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

const QUESTIONS = [
  { q: "ubiquitous", a: "至る所にある" },
  { q: "meticulous", a: "細心の注意を払う" },
  { q: "ambiguous", a: "曖昧な" },
  { q: "cognitive", a: "認知の" },
  { q: "inevitable", a: "避けられない" },
  { q: "arbitrary", a: "恣意的な" },
  { q: "plausible", a: "もっともらしい" },
  { q: "coherent", a: "首尾一貫した" },
  { q: "salient", a: "顕著な" },
  { q: "implicit", a: "暗黙の" }
];

let subject_id, session;
let index = 0;
let answers = [];
let answered = false;

init();

function init() {
  document.getElementById("main").innerHTML = `
    <input id="sid" placeholder="A01 または B01"><br><br>
    <select id="session">
      <option value="initial">初回学習</option>
      <option value="review">復習</option>
      <option value="test" selected>テスト</option>
    </select><br><br>
    <button onclick="start()">開始</button>
  `;
}

function start() {
  subject_id = document.getElementById("sid").value.trim();
  session = document.getElementById("session").value;

  if (!/^([AB][0-9]{2})$/.test(subject_id)) {
    alert("ID形式が不正です");
    return;
  }
  showQuestion();
}

function showQuestion() {
  answered = false;
  const item = QUESTIONS[index];

  if (session === "initial") {
    document.getElementById("main").innerHTML = `
      <p>${index + 1} / ${QUESTIONS.length}</p>

      <p><b>問題（英語）</b></p>
      <p>${item.q}</p>
      <textarea placeholder="英単語を書き写す"></textarea>

      <p><b>意味（日本語）</b></p>
      <p>${item.a}</p>
      <textarea placeholder="意味を書き写す"></textarea>

      <button onclick="next()">次へ</button>
    `;
  } else {
    document.getElementById("main").innerHTML = `
      <p>${index + 1} / ${QUESTIONS.length}</p>
      <p><b>${item.q}</b></p>
      <input id="ans">
      <button onclick="check()">回答</button>
    `;
  }
}

function check() {
  if (answered) return;
  answered = true;

  const ans = document.getElementById("ans").value.trim();
  const correct = QUESTIONS[index].a;
  answers.push(ans);

  document.getElementById("main").innerHTML = `
    <p>${QUESTIONS[index].q}</p>
    <p>あなた：${ans}</p>
    <p>正解：${correct}</p>
    <button onclick="next()">次へ</button>
  `;
}

function next() {
  if (session === "initial") {
    answers.push(QUESTIONS[index].a); // 学習扱い
  }
  index++;
  if (index < QUESTIONS.length) showQuestion();
  else finish();
}

async function finish() {
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      subject_id,
      session,
      answers
    })
  });

  const data = await res.json();

  document.getElementById("main").innerHTML = `
    <h3>完了</h3>
    <p>正答率：${(data.retention * 100).toFixed(1)}%</p>
    <p>次回学習日：${new Date(data.next_date).toLocaleDateString()}</p>
  `;
}
</script>
</body>
</html>
