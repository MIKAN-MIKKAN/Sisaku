<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>記憶実験</title>
<meta name="viewport" content="width=device-width">
<style>
  textarea {
    width: 100%;
    height: 50px;
    font-size: 16px;
  }
  #loading {
    color: blue;
    font-weight: bold;
    margin-top: 10px;
  }
</style>
</head>

<body>
<h2>記憶実験</h2>
<div id="main"></div>
<div id="loading" style="display:none;">通信中…</div>

<script>
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwg8kL5Pcx82IqaLx8OdRXDm_XZ0xEbdJ1iWZCCzxhhBee99yJlqJjRLEpI2Qk3uTkkRw/exec";

const QUESTIONS = [
  { q: "ubiquitous", a: "至る所にある" },
  { q: "meticulous", a: "細心の注意を払う" },
  { q: "ambiguous", a: "曖昧な" },
  { q: "cognitive", a: "認知の" },
  { q: "inevitable", a: "避けられない" },
  { q: "arbitrary", a: "恣意的な" },
  { q: "plausible", a: "もっともらしい" },
  { q: "coherent", a: "首尾一貫した" },
  { q: "salient", a: "顕著な" },
  { q: "implicit", a: "暗黙の" }
];

let subject_id, session;
let index = 0;
let answers = [];

init();

function init() {
  document.getElementById("main").innerHTML = `
    <input id="sid" placeholder="A01 または B01"><br><br>
    <select id="session">
      <option value="initial">初回学習</option>
      <option value="review">復習</option>
      <option value="test" selected>テスト</option>
    </select><br><br>
    <button onclick="start()">開始</button>
  `;
}

function start() {
  subject_id = document.getElementById("sid").value.trim();
  session = document.getElementById("session").value;

  if (!/^([AB][0-9]{2})$/.test(subject_id)) {
    alert("ID形式が不正です");
    return;
  }
  showQuestion();
}

function showQuestion() {
  const item = QUESTIONS[index];

  document.getElementById("main").innerHTML = `
    <p>${index + 1} / ${QUESTIONS.length}</p>
    <p><b>${item.q}</b></p>
    ${session === "initial" ? `<p>答え：${item.a}</p>` : ""}
    <textarea id="ans"></textarea>
    <button onclick="check()">次へ</button>
  `;
}

function check() {
  const input = document.getElementById("ans").value.trim();
  const correct = QUESTIONS[index].a;

  if (session === "initial" && input !== correct) {
    alert("正しく書き写してください");
    return;
  }

  answers.push(input);
  index++;
  if (index < QUESTIONS.length) showQuestion();
  else finish();
}

async function finish() {
  document.getElementById("loading").style.display = "block";

  try {
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ subject_id, session, answers })
    });

    const data = await res.json();

    document.getElementById("loading").style.display = "none";

    document.getElementById("main").innerHTML = `
      <h3>完了</h3>
      <p>得点：${data.score} / 10</p>
      <p>次回学習日：${new Date(data.next_date).toLocaleDateString()}</p>
    `;
  } catch {
    document.getElementById("loading").textContent = "通信エラー";
  }
}
</script>
</body>
</html>
